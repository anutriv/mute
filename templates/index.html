<script>
    const renderURL = "https://mute-77q0.onrender.com";  // Ensure this is your actual Flask URL
    let uploaded = false;

    window.onload = function() {
        console.log("Page loaded successfully.");
    };

    function uploadFiles() {
        let video = document.getElementById("videoFile").files[0];
        let timestamps = document.getElementById("timestampsFile").files[0];

        if (!video || !timestamps) {
            alert("Please select both files.");
            return;
        }

        let formData = new FormData();
        formData.append("video", video);
        formData.append("timestamps", timestamps);

        let xhr = new XMLHttpRequest();
        xhr.open("POST", renderURL + "/upload", true);

        // Track upload progress in real-time
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                let percentComplete = Math.round((event.loaded / event.total) * 100);
                document.getElementById("progressPercent").textContent = percentComplete + "%";
            }
        };

        // Handle successful upload
        xhr.onload = function() {
            if (xhr.status === 200) {
                alert("Files uploaded successfully! Starting processing...");
                uploaded = true;
                processVideo();
            } else {
                alert("Upload failed: " + xhr.responseText);
            }
        };

        // Handle errors during upload
        xhr.onerror = function() {
            alert("Error uploading files.");
            console.error("XHR Error:", xhr.statusText);
        };

        xhr.send(formData);
    }

    function processVideo() {
        if (!uploaded) {
            alert("Upload files first.");
            return;
        }

        let xhr = new XMLHttpRequest();
        xhr.open("GET", renderURL + "/process", true);
        xhr.responseType = "blob"; // Expect binary file (video)

        // Handle successful processing
        xhr.onload = function() {
            if (xhr.status === 200) {
                let url = URL.createObjectURL(xhr.response);
                document.getElementById("download").href = url;
                document.getElementById("download").style.display = "inline";
                alert("Muted video is ready for download!");
            } else {
                alert("Processing failed: " + xhr.responseText);
            }
        };

        // Handle errors during processing
        xhr.onerror = function() {
            alert("Error processing video.");
            console.error("Processing Error:", xhr.statusText);
        };

        xhr.send();
    }
</script>
