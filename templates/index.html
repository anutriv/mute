<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mute Video Sections</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 50px; }
        input, button { margin: 10px; }
        #progress { display: none; }
        #download { display: none; }
    </style>
</head>
<body>

    <h2>Upload MP4 and Timestamp File</h2>
    <label for="videoFile">Choose MP4 File:</label>
    <input type="file" id="videoFile" accept="video/mp4"><br>
    <label for="timestampsFile">Choose Timestamp File:</label>
    <input type="file" id="timestampsFile" accept=".txt"><br>

    <button onclick="uploadFiles()">Upload Files</button>
    <p id="progress">Uploading: <span id="progressPercent">0%</span></p>

    <button id="processButton" onclick="processVideo()" style="display:none;">Get Muted Video</button>
    <br>
    <a id="download" href="#" download="output.mp4">Download Muted Video</a>

    <script>
        const renderURL = "https://mute-77q0.onrender.com";  // Update this with your actual Render Flask URL
        let uploaded = false;

        // Ensure no fetch request runs on page load
        window.onload = function() {
            console.log("Page loaded successfully.");
        };

        function uploadFiles() {
            let video = document.getElementById("videoFile").files[0];
            let timestamps = document.getElementById("timestampsFile").files[0];

            if (!video || !timestamps) {
                alert("Please select both files.");
                return;
            }

            let formData = new FormData();
            formData.append("video", video);
            formData.append("timestamps", timestamps);

            document.getElementById("progress").style.display = "block";
            document.getElementById("progressPercent").textContent = "0%";

            fetch(renderURL + "/upload", {
                method: "POST",
                body: formData
            })
            .then(response => response.text())  // Read response as text to handle any format
            .then(data => {
                console.log("Upload response:", data);  // Debugging log
                if (data.includes("success")) {
                    document.getElementById("progressPercent").textContent = "100%";
                    alert("Files uploaded successfully! Starting processing...");
                    uploaded = true;
                    processVideo();
                } else {
                    alert("Upload failed: " + data);
                }
            })
            .catch(error => {
                alert("Error uploading files: " + error);
                console.error("Fetch error:", error);
            });
        }

        function processVideo() {
            if (!uploaded) {
                alert("Upload files first.");
                return;
            }

            fetch(renderURL + "/process")
            .then(response => response.blob())
            .then(blob => {
                let url = URL.createObjectURL(blob);
                document.getElementById("download").href = url;
                document.getElementById("download").style.display = "inline";
                alert("Muted video is ready for download!");
            })
            .catch(error => {
                alert("Error processing video: " + error);
                console.error("Processing error:", error);
            });
        }
    </script>

</body>
</html>
